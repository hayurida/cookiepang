<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìš°ë¦¬ë°˜ ì¿ í‚¤ìƒì  ì¿ í‚¤íŒ¡! - v32 (ê´€ë¦¬ìí¼ ë¦¬ë‰´ì–¼)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Jua&family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans KR', sans-serif; background-color: #e5e7eb; display: flex; justify-content: center; min-height: 100vh; }
        .font-jua { font-family: 'Jua', sans-serif; }
        .app-container { width: 100%; max-width: 768px; background: white; min-height: 100vh; box-shadow: 0 0 25px rgba(0,0,0,0.1); position: relative; padding-bottom: 80px; overflow-x: hidden; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .nav-item.active { color: #2563eb; font-weight: bold; }
        .nav-item.active svg { stroke: #2563eb; stroke-width: 2.5; }
        .price-strike { text-decoration: line-through; color: #9ca3af; font-size: 0.8rem; margin-right: 4px; }
        .cat-btn.active { background-color: #2563eb; color: white; border-color: #2563eb; }
        .prod-img-box img { width: 100%; height: 100%; object-fit: cover; border-radius: 0.5rem; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
    </style>
</head>
<body>

<div class="app-container">
    <!-- í—¤ë” -->
    <header class="sticky top-0 z-50 bg-white border-b border-gray-200 shadow-sm">
        <div class="flex items-center justify-between px-6 py-4">
            <h1 class="flex items-center cursor-pointer" onclick="location.reload()">
                <img src="cookiepang.png" class="h-14 object-contain" onerror="this.style.display='none'; this.parentElement.innerText='ğŸª ì¿ í‚¤íŒ¡'">
            </h1>
            <div class="flex items-center gap-3">
                <div id="user-status" class="hidden flex items-center gap-2">
                    <div class="bg-yellow-50 text-yellow-800 px-4 py-2 rounded-full text-sm font-bold border border-yellow-200 flex items-center gap-1 shadow-sm">
                        <span id="user-name-display" class="mr-1"></span>
                        ğŸª <span id="my-cookie">0</span>
                    </div>
                </div>
                <button id="admin-entry-btn" onclick="openAdmin()" class="flex items-center gap-1 text-gray-500 hover:text-gray-900 bg-gray-100 px-3 py-2 rounded-lg transition active:bg-gray-200">
                    <i data-lucide="settings" class="w-5 h-5"></i>
                    <span class="text-sm font-bold">ì„¤ì •</span>
                </button>
            </div>
        </div>
    </header>

    <!-- 1. ë¡œê·¸ì¸ í™”ë©´ -->
    <section id="login-section" class="p-10 flex flex-col items-center justify-center h-[70vh]">
        <div class="text-center mb-10">
            <div class="text-7xl mb-6 animate-bounce">ğŸª</div>
            <h2 class="text-3xl font-bold mb-3 text-gray-800">ìš°ë¦¬ë°˜ ì¿ í‚¤ ìƒì </h2>
            <p class="text-gray-500">ë‹¤í–ˆë‹ˆ í•™ìƒ ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”</p>
        </div>
        <div class="w-full max-w-sm space-y-4">
            <input type="text" id="student-code-input" class="w-full border-2 border-gray-200 p-4 rounded-xl text-xl text-center focus:outline-none focus:border-blue-500 transition" placeholder="í•™ìƒ ì½”ë“œ (ì˜ˆ: XYZ123)">
            <button onclick="loginWithAPI()" class="w-full bg-blue-600 text-white p-4 rounded-xl font-bold text-xl hover:bg-blue-700 shadow-lg transition transform active:scale-95">ì…ì¥í•˜ê¸°</button>
            <button onclick="loginDemo()" class="w-full bg-gray-100 text-gray-500 p-3 rounded-xl font-bold text-sm hover:bg-gray-200">ì²´í—˜í•˜ê¸° (í…ŒìŠ¤íŠ¸ìš©)</button>
            
            <button onclick="openRequestModal()" class="w-full mt-4 text-gray-500 text-sm hover:text-blue-600 underline decoration-dashed underline-offset-4 transition">
                ğŸ’¡ ì›í•˜ëŠ” ìƒí’ˆì´ ìˆë‚˜ìš”? ì…ê³  ìš”ì²­í•˜ê¸°
            </button>
        </div>
        <p class="mt-8 text-xs text-gray-400 text-center bg-gray-50 p-2 rounded-lg">
            â€» ë‹¤í–ˆë‹ˆ API ì •ì±…ìƒ ë³¸ ì•±ì—ì„œì˜ ì¿ í‚¤ ì°¨ê°ì€<br>ë‹¤í–ˆë‹ˆ ì„œë²„ì— ìë™ ë°˜ì˜ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
        </p>
    </section>

    <!-- 2. ë©”ì¸ ì‡¼í•‘ëª° -->
    <section id="tab-home" class="hidden tab-content pb-20 animate-[fadeIn_0.3s_ease-out]">
        <div id="smart-banner" class="hidden bg-gradient-to-r from-red-500 to-pink-600 text-white py-3 px-4 shadow-md overflow-hidden relative">
            <div class="flex items-center gap-3">
                <span class="bg-white text-red-600 text-xs font-bold px-2 py-1 rounded-full animate-pulse">HOT</span>
                <div id="banner-text" class="text-base font-bold truncate flex-1">ì˜¤ëŠ˜ì˜ íŠ¹ê°€!</div>
            </div>
        </div>
        
        <div class="flex overflow-x-auto gap-2 p-4 scrollbar-hide sticky top-[72px] bg-white/95 z-30 backdrop-blur-sm border-b border-gray-100" id="category-container"></div>
        <div id="product-list" class="grid grid-cols-2 md:grid-cols-3 gap-4 px-4 py-4"></div>
    </section>

    <!-- 3. ê²€ìƒ‰ íƒ­ -->
    <section id="tab-search" class="hidden tab-content p-6 pb-20 animate-[fadeIn_0.3s_ease-out]">
        <h2 class="text-2xl font-bold mb-6">ìƒí’ˆ ê²€ìƒ‰</h2>
        <div class="relative mb-8">
            <input type="text" id="search-input" onkeyup="filterProducts()" class="w-full border-2 border-blue-500 rounded-xl p-4 pl-12 text-lg focus:outline-none focus:ring-4 focus:ring-blue-100" placeholder="ë¬´ì—‡ì„ ì°¾ê³  ê³„ì‹ ê°€ìš”?">
            <i data-lucide="search" class="absolute left-4 top-5 text-blue-500 w-6 h-6"></i>
        </div>
        <div id="search-results" class="grid grid-cols-2 md:grid-cols-3 gap-4"></div>
        <div id="no-search-result" class="hidden text-center text-gray-400 mt-20"><i data-lucide="search-x" class="w-16 h-16 mx-auto mb-4 opacity-30"></i><p class="text-lg">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p></div>
    </section>

    <!-- 4. ì¥ë°”êµ¬ë‹ˆ -->
    <section id="section-cart" class="hidden tab-content bg-gray-50 min-h-screen z-[60] absolute inset-0 top-[80px] animate-[slideUp_0.3s_ease-out]">
        <div class="p-4 bg-white border-b sticky top-0 z-10 flex items-center shadow-sm">
            <button onclick="closeCart()" class="mr-4 p-2 hover:bg-gray-100 rounded-full"><i data-lucide="arrow-left" class="w-6 h-6"></i></button>
            <h2 class="text-2xl font-bold">ì¥ë°”êµ¬ë‹ˆ</h2>
        </div>
        <div id="cart-list" class="p-4 space-y-4 pb-40"></div>
        <div id="cart-empty" class="hidden text-center text-gray-400 mt-32"><i data-lucide="shopping-cart" class="w-20 h-20 mx-auto mb-6 opacity-30"></i><p class="text-xl">ì¥ë°”êµ¬ë‹ˆê°€ ë¹„ì–´ìˆì–´ìš”.</p><button onclick="closeCart()" class="mt-6 bg-blue-600 text-white px-8 py-3 rounded-full font-bold shadow-lg hover:bg-blue-700 transition">ìƒí’ˆ ë‹´ìœ¼ëŸ¬ ê°€ê¸°</button></div>
        <div id="cart-checkout-bar" class="fixed bottom-0 left-0 right-0 bg-white border-t p-6 shadow-[0_-4px_20px_rgba(0,0,0,0.1)] w-full max-w-[768px] mx-auto hidden z-[70] rounded-t-3xl">
            <div class="flex justify-between items-center mb-4"><span class="text-gray-600 font-bold text-lg">ì´ ê²°ì œ ê¸ˆì•¡</span><span class="text-3xl font-bold text-red-600"><span id="cart-total">0</span> ì¿ í‚¤</span></div>
            <button onclick="checkoutCart()" class="w-full bg-blue-600 text-white py-4 rounded-xl font-bold text-xl hover:bg-blue-700 shadow-lg transform active:scale-[0.98] transition">ê²°ì œí•˜ê¸°</button>
        </div>
    </section>

    <!-- 5. ì„ ìƒë‹˜ ê´€ë¦¬ì ëª¨ë“œ -->
    <section id="section-admin" class="hidden absolute inset-0 bg-white z-[100] p-6 overflow-y-auto animate-[fadeIn_0.2s_ease-out]">
        <div class="flex justify-between items-center mb-8 sticky top-0 bg-white pt-2 pb-4 border-b z-10">
            <h2 class="text-2xl font-bold text-gray-800">ğŸ‘¨â€ğŸ« ì„ ìƒë‹˜ ê´€ë¦¬ ëª¨ë“œ</h2>
            <button onclick="closeAdmin()" class="bg-gray-100 p-2 rounded-full hover:bg-gray-200 cursor-pointer"><i data-lucide="x" class="w-6 h-6"></i></button>
        </div>

        <div class="flex mb-8 bg-gray-100 p-1.5 rounded-xl">
            <button onclick="switchAdminTab('products')" id="admin-tab-btn-products" class="flex-1 py-3 rounded-lg bg-white shadow-sm text-sm font-bold transition">ğŸ“¦ ìƒí’ˆ ì„¤ì •</button>
            <button onclick="switchAdminTab('orders')" id="admin-tab-btn-orders" class="flex-1 py-3 rounded-lg text-gray-500 text-sm font-bold hover:bg-gray-200 transition">ğŸšš ì£¼ë¬¸ ê´€ë¦¬</button>
            <button onclick="switchAdminTab('requests')" id="admin-tab-btn-requests" class="flex-1 py-3 rounded-lg text-gray-500 text-sm font-bold hover:bg-gray-200 transition">ğŸ™‹â€â™‚ï¸ ì…ê³  ìš”ì²­</button>
        </div>

        <!-- [1] ìƒí’ˆ ê´€ë¦¬ íƒ­ -->
        <div id="admin-tab-products" class="pb-20">
            <div class="bg-gray-50 p-5 rounded-2xl mb-6 border border-gray-200">
                <h3 class="font-bold mb-3 flex items-center gap-2 text-gray-700"><i data-lucide="key" class="w-5 h-5"></i> ë‹¤í–ˆë‹ˆ API ì„¤ì •</h3>
                <div class="flex gap-2">
                    <input type="password" id="dahandin-api-key" placeholder="ë‹¤í–ˆë‹ˆ API Key ì…ë ¥" class="flex-1 border p-3 rounded-lg text-sm bg-white">
                    <button onclick="saveApiKey()" class="bg-gray-700 text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-gray-800">ì €ì¥</button>
                </div>
            </div>

            <div class="bg-red-50 p-5 rounded-2xl mb-6 border border-red-100 shadow-sm">
                <h3 class="font-bold mb-4 flex items-center gap-2 text-red-800"><i data-lucide="percent" class="w-5 h-5"></i> ì „ì²´ í• ì¸ ì„¤ì •</h3>
                <div class="flex gap-2 text-xs justify-between">
                    <button onclick="applyGlobalDiscount(10)" class="bg-white border-2 border-red-200 px-2 py-3 rounded-lg hover:bg-red-100 flex-1 font-bold text-red-600 transition">10%</button>
                    <button onclick="applyGlobalDiscount(20)" class="bg-white border-2 border-red-200 px-2 py-3 rounded-lg hover:bg-red-100 flex-1 font-bold text-red-600 transition">20%</button>
                    <button onclick="applyGlobalDiscount(30)" class="bg-white border-2 border-red-200 px-2 py-3 rounded-lg hover:bg-red-100 flex-1 font-bold text-red-600 transition">30%</button>
                    <button onclick="applyGlobalDiscount(40)" class="bg-white border-2 border-red-200 px-2 py-3 rounded-lg hover:bg-red-100 flex-1 font-bold text-red-600 transition">40%</button>
                    <button onclick="applyGlobalDiscount(50)" class="bg-white border-2 border-red-200 px-2 py-3 rounded-lg hover:bg-red-100 flex-1 font-bold text-red-600 transition">50%</button>
                    <button onclick="applyGlobalDiscount(0)" class="bg-gray-200 px-2 py-3 rounded-lg hover:bg-gray-300 font-bold text-gray-600">ì´ˆê¸°í™”</button>
                </div>
            </div>

            <div class="bg-blue-50 p-5 rounded-2xl mb-8 border border-blue-100 shadow-sm">
                <h3 class="font-bold mb-4 flex items-center gap-2 text-blue-800" id="form-title"><i data-lucide="plus-circle" class="w-6 h-6"></i> ìƒí’ˆ ê´€ë¦¬</h3>
                
                <!-- [NEW] ë¦¬ë‰´ì–¼ëœ ìƒí’ˆ ë“±ë¡ í¼ -->
                <div class="space-y-3">
                    <!-- Row 1: ìƒí’ˆëª… -->
                    <div class="w-full">
                        <label class="block text-xs font-bold text-gray-500 mb-1 ml-1">ìƒí’ˆëª…</label>
                        <input id="new-prod-name" type="text" placeholder="ì˜ˆ: ììœ ì‹œê°„ 1íšŒê¶Œ" class="w-full border border-blue-200 p-3 rounded-xl focus:ring-2 focus:ring-blue-300 outline-none">
                    </div>

                    <!-- Row 2: ì´ëª¨ì§€(20%) + ì¹´í…Œê³ ë¦¬(80%) -->
                    <div class="flex gap-2">
                        <div class="w-[20%]">
                            <label class="block text-xs font-bold text-gray-500 mb-1 ml-1 text-center">ì•„ì´ì½˜</label>
                            <input id="new-prod-icon" type="text" placeholder="ğŸ" class="w-full border border-blue-200 p-3 rounded-xl text-center focus:ring-2 focus:ring-blue-300 outline-none">
                        </div>
                        <div class="w-[80%]">
                            <label class="block text-xs font-bold text-gray-500 mb-1 ml-1">ì¹´í…Œê³ ë¦¬</label>
                            <input id="new-prod-cat" type="text" placeholder="ì§ì ‘ ì…ë ¥í•˜ê±°ë‚˜ ì•„ë˜ íƒœê·¸ ì„ íƒ" class="w-full border border-blue-200 p-3 rounded-xl focus:ring-2 focus:ring-blue-300 outline-none">
                            <!-- [NEW] ì¹´í…Œê³ ë¦¬ ì¹© ì˜ì—­ -->
                            <div id="category-chip-area" class="flex flex-wrap gap-2 mt-2">
                                <!-- JSë¡œ ë Œë”ë§ë¨ -->
                            </div>
                        </div>
                    </div>

                    <!-- Row 3: 2x2 ê·¸ë¦¬ë“œ (ê°€ê²©, ì¬ê³ , í• ì¸, ìœ íš¨ê¸°ê°„) -->
                    <div class="grid grid-cols-2 gap-3 bg-white p-3 rounded-xl border border-blue-100">
                        <!-- ê°€ê²© -->
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-1 ml-1">ê°€ê²© (ì¿ í‚¤)</label>
                            <input id="new-prod-price" type="number" placeholder="50" class="w-full border-b-2 border-gray-200 p-2 text-center font-bold text-lg focus:outline-none focus:border-blue-500">
                        </div>
                        <!-- ì¬ê³  -->
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-1 ml-1">ì¬ê³  (ê°œ)</label>
                            <input id="new-prod-stock" type="number" placeholder="99" class="w-full border-b-2 border-gray-200 p-2 text-center font-bold text-lg focus:outline-none focus:border-blue-500">
                        </div>
                        <!-- í• ì¸ -->
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-1 ml-1">í• ì¸ìœ¨ (%)</label>
                            <input id="new-prod-discount" type="number" min="0" max="100" placeholder="0" class="w-full border-b-2 border-gray-200 p-2 text-center font-bold text-lg focus:outline-none focus:border-blue-500 text-red-500">
                        </div>
                        <!-- [NEW] ìœ íš¨ê¸°ê°„ -->
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-1 ml-1">ìœ íš¨ê¸°ê°„ (ì¼)</label>
                            <input id="new-prod-expiry" type="number" min="1" placeholder="30" value="30" class="w-full border-b-2 border-gray-200 p-2 text-center font-bold text-lg focus:outline-none focus:border-blue-500 text-indigo-500">
                        </div>
                    </div>

                    <!-- Row 4: ì‚¬ì§„ ì—…ë¡œë“œ -->
                    <label class="block w-full text-center bg-white border border-gray-300 rounded-xl py-3 text-sm font-bold text-gray-600 cursor-pointer hover:bg-gray-50 transition shadow-sm">
                        <i data-lucide="camera" class="w-4 h-4 inline mr-1"></i> ëŒ€í‘œ ì´ë¯¸ì§€ ì—…ë¡œë“œ (ì„ íƒ)
                        <input type="file" id="new-prod-img-file" accept="image/*" class="hidden" onchange="previewImage(this)">
                    </label>
                    
                    <!-- ëŒ€í‘œ ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° -->
                    <div id="img-preview-area" class="hidden w-full h-40 bg-gray-200 rounded-xl flex items-center justify-center relative border-2 border-dashed border-gray-400 mt-2">
                        <img id="img-preview" class="h-full object-contain rounded-lg">
                        <button onclick="clearImage()" class="absolute top-2 right-2 bg-gray-800 text-white rounded-full p-1.5 w-7 h-7 flex items-center justify-center text-sm hover:bg-black transition">x</button>
                    </div>

                    <!-- Row 5: ì‹œí¬ë¦¿ ì¿ í° ì„¤ì • -->
                    <div class="bg-yellow-50 p-4 rounded-xl border border-yellow-200 mt-2">
                        <label class="flex items-center gap-2 cursor-pointer mb-2">
                            <input type="checkbox" id="is-secret-mode" class="w-5 h-5 accent-yellow-600" onchange="toggleSecretMode()">
                            <span class="text-sm font-bold text-yellow-800">ğŸŸï¸ ì‹œí¬ë¦¿ ì¿ í°(ë°”ì½”ë“œ) ì„¤ì •</span>
                        </label>
                        <p class="text-xs text-yellow-600 mb-3 ml-7">
                            ì²´í¬ ì‹œ, <b>ëŒ€ëŸ‰ìœ¼ë¡œ ì—…ë¡œë“œí•œ ì¿ í° ì´ë¯¸ì§€</b>ê°€ í•™ìƒë“¤ì—ê²Œ<br>
                            êµ¬ë§¤ ìˆœì„œëŒ€ë¡œ <b>ìë™ ë°œì†¡(ì°¨ê°)</b>ë©ë‹ˆë‹¤.<br>
                            <span class="text-red-500 font-bold">* ì¬ê³ ëŠ” ì—…ë¡œë“œí•œ ì´ë¯¸ì§€ ê°œìˆ˜ë¡œ ìë™ ì„¤ì •ë©ë‹ˆë‹¤.</span>
                        </p>
                        
                        <div id="secret-img-area" class="hidden ml-1">
                            <label class="block w-full text-center bg-white border border-dashed border-yellow-400 rounded-lg py-4 text-sm font-bold text-yellow-700 cursor-pointer hover:bg-yellow-100 transition shadow-sm">
                                <i data-lucide="images" class="w-5 h-5 inline mr-1"></i> ì¿ í° ì´ë¯¸ì§€ ì¼ê´„ ì—…ë¡œë“œ (ì—¬ëŸ¬ì¥ ê°€ëŠ¥)
                                <input type="file" id="secret-img-file" accept="image/*" class="hidden" multiple onchange="previewSecretImage(this)">
                            </label>
                            
                            <!-- ì‹œí¬ë¦¿ ì´ë¯¸ì§€ ëª©ë¡ ë¯¸ë¦¬ë³´ê¸° -->
                            <div id="secret-img-preview-box" class="hidden mt-3 relative bg-white rounded-lg border border-yellow-200 p-2 max-h-60 overflow-y-auto">
                                <!-- JSë¡œ ë Œë”ë§ -->
                            </div>
                        </div>
                    </div>

                    <div class="flex gap-2 pt-4">
                        <button id="btn-submit-prod" onclick="handleProductSubmit()" class="flex-1 bg-blue-600 text-white py-4 rounded-xl font-bold text-lg hover:bg-blue-700 shadow-md transition transform active:scale-95">ë“±ë¡í•˜ê¸°</button>
                        <button id="btn-cancel-edit" onclick="cancelEdit()" class="hidden w-24 bg-gray-200 text-gray-600 py-4 rounded-xl font-bold hover:bg-gray-300 transition">ì·¨ì†Œ</button>
                    </div>
                </div>
            </div>
            <h3 class="font-bold mb-4 text-xl flex items-center gap-2"><i data-lucide="package" class="w-6 h-6"></i> ë“±ë¡ëœ ìƒí’ˆ ëª©ë¡</h3>
            <div id="admin-prod-list" class="space-y-3 mb-8 min-h-[100px]"></div>
        </div>

        <!-- [2] ì£¼ë¬¸/ë°°ì†¡ ê´€ë¦¬ íƒ­ -->
        <div id="admin-tab-orders" class="hidden pb-20">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-xl flex items-center gap-2 text-orange-600"><i data-lucide="truck" class="w-6 h-6"></i> ë¯¸ë°°ì†¡ ì£¼ë¬¸ ë‚´ì—­</h3>
                <button onclick="approveAllOrders()" class="bg-blue-100 text-blue-700 px-3 py-1.5 rounded-lg text-xs font-bold hover:bg-blue-200 flex items-center gap-1 transition"><i data-lucide="check-square" class="w-4 h-4"></i> ì „ì²´ ìŠ¹ì¸</button>
            </div>
            
            <div id="admin-order-list" class="space-y-3 mb-10"></div>
            <div id="admin-order-empty" class="text-center py-16 text-gray-400 bg-gray-50 rounded-2xl border border-dashed border-gray-200 hidden"><i data-lucide="inbox" class="w-12 h-12 mx-auto mb-2 opacity-30"></i><p>í˜„ì¬ ëŒ€ê¸° ì¤‘ì¸ ì£¼ë¬¸ì´ ì—†ìŠµë‹ˆë‹¤.</p></div>

            <hr class="my-8 border-gray-200">

            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-xl flex items-center gap-2 text-green-700"><i data-lucide="check-circle" class="w-6 h-6"></i> ê²°ì œ(ë°°ì†¡) ì™„ë£Œ ë‚´ì—­</h3>
                <button onclick="openSettlementModal()" class="bg-yellow-100 text-yellow-800 px-3 py-1.5 rounded-lg text-xs font-bold hover:bg-yellow-200 flex items-center gap-1"><i data-lucide="calculator" class="w-4 h-4"></i> ë¯¸ì •ì‚° ë‚´ì—­ í™•ì¸</button>
            </div>
            
            <div class="flex gap-2 mb-4">
                <input type="text" id="order-search" placeholder="í•™ìƒ ì´ë¦„ ë˜ëŠ” ìƒí’ˆëª… ê²€ìƒ‰" class="border border-gray-300 p-3 rounded-xl w-full text-base focus:outline-none focus:border-blue-500" onkeyup="renderCompletedOrders(1)">
                <button onclick="renderCompletedOrders(1)" class="bg-gray-200 p-3 rounded-xl text-gray-600 hover:bg-gray-300"><i data-lucide="search" class="w-6 h-6"></i></button>
            </div>

            <div id="admin-completed-list" class="space-y-2 mb-6"></div>
            <div id="order-pagination" class="flex justify-center gap-2 text-sm"></div>
        </div>

        <!-- [3] ì…ê³  ìš”ì²­ ê´€ë¦¬ íƒ­ -->
        <div id="admin-tab-requests" class="hidden pb-20">
            <h3 class="font-bold mb-4 text-xl flex items-center gap-2 text-indigo-700">
                <i data-lucide="message-square-plus" class="w-6 h-6"></i> í•™ìƒ ì…ê³  ìš”ì²­ ëª©ë¡
            </h3>
            <div class="bg-indigo-50 p-4 rounded-xl border border-indigo-100 mb-6 text-sm text-indigo-800">
                * í•™ìƒë“¤ì´ <b>[ì…ê³  ìš”ì²­í•˜ê¸°]</b>ë¥¼ í†µí•´ ë³´ë‚¸ ë©”ì‹œì§€ì…ë‹ˆë‹¤.<br>
                * í¬ë§ ìƒí’ˆì´ë‚˜ ê±´ì˜ì‚¬í•­ì„ í™•ì¸í•˜ê³  ê´€ë¦¬í•´ì£¼ì„¸ìš”.
            </div>
            
            <div id="admin-request-list" class="space-y-3"></div>
            <div id="admin-request-empty" class="hidden text-center py-16 text-gray-400 bg-gray-50 rounded-2xl border border-dashed border-gray-200">
                <i data-lucide="mail-open" class="w-12 h-12 mx-auto mb-2 opacity-30"></i>
                <p>ë“±ë¡ëœ ì…ê³  ìš”ì²­ì´ ì—†ìŠµë‹ˆë‹¤.</p>
            </div>
        </div>

        <div class="border-t pt-8 pb-20 space-y-6">
            <div class="bg-gray-100 p-5 rounded-2xl">
                <h4 class="font-bold text-sm mb-3 text-gray-600 flex items-center gap-2"><i data-lucide="lock" class="w-4 h-4"></i> ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</h4>
                <div class="flex gap-2">
                    <input type="password" id="new-admin-pw" placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸" class="flex-1 border p-3 rounded-lg text-sm bg-white">
                    <button onclick="changeAdminPw()" class="bg-gray-700 text-white px-5 py-3 rounded-lg text-sm font-bold hover:bg-gray-800 transition">ë³€ê²½</button>
                </div>
            </div>
            <div class="text-center">
                <button onclick="resetProducts()" class="text-red-500 text-sm underline hover:text-red-700 font-medium">ì‹œìŠ¤í…œ ì´ˆê¸°í™” (ëª¨ë“  ë°ì´í„° ì‚­ì œ)</button>
            </div>
        </div>
    </section>

    <!-- 6. êµ¬ë§¤ë‚´ì—­ íƒ­ -->
    <section id="tab-history" class="hidden tab-content p-6 pb-20 animate-[fadeIn_0.3s_ease-out]">
        <h2 class="text-2xl font-bold mb-6">êµ¬ë§¤/ë°°ì†¡ ë‚´ì—­</h2>
        <div id="history-list" class="space-y-4"></div>
    </section>

    <nav id="bottom-nav" class="hidden fixed bottom-0 w-full max-w-[768px] bg-white border-t border-gray-200 flex justify-around py-3 z-30 text-xs text-gray-400 font-medium shadow-[0_-4px_20px_rgba(0,0,0,0.05)]">
        <button onclick="switchTab('home')" class="nav-item active flex flex-col items-center p-2 w-full transition" id="nav-home"><i data-lucide="home" class="w-6 h-6 mb-1"></i><span class="mt-1">ìƒì </span></button>
        <button onclick="switchTab('search')" class="nav-item flex flex-col items-center p-2 w-full transition" id="nav-search"><i data-lucide="search" class="w-6 h-6 mb-1"></i><span class="mt-1">ê²€ìƒ‰</span></button>
        <button onclick="openCart()" class="nav-item flex flex-col items-center p-2 w-full relative transition"><i data-lucide="shopping-cart" class="w-6 h-6 mb-1"></i><span class="mt-1">ì¥ë°”êµ¬ë‹ˆ</span><span id="nav-cart-badge" class="absolute top-1 right-12 bg-red-600 text-white text-[10px] font-bold px-1.5 py-0.5 rounded-full hidden animate-bounce">0</span></button>
        <button onclick="switchTab('history')" class="nav-item flex flex-col items-center p-2 w-full transition" id="nav-history"><i data-lucide="list" class="w-6 h-6 mb-1"></i><span class="mt-1">ë‚´ì—­</span></button>
    </nav>
</div>

<!-- ë°”ë¡œêµ¬ë§¤ ëª¨ë‹¬ -->
<div id="modal-backdrop" class="fixed inset-0 bg-black/60 z-[70] hidden flex items-center justify-center p-4 backdrop-blur-sm animate-[fadeIn_0.2s_ease-out]">
    <div class="bg-white rounded-2xl w-full max-w-sm p-8 shadow-2xl relative">
        <button onclick="closeModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 p-1"><i data-lucide="x" class="w-6 h-6"></i></button>
        <div class="text-center">
            <div id="modal-img-area" class="w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-6 text-4xl overflow-hidden bg-blue-50 border border-blue-100">ğŸ</div>
            <h3 class="font-bold text-2xl mb-2 text-gray-800" id="modal-title">ìƒí’ˆëª…</h3>
            <p class="text-gray-500 text-base mb-6">ë°”ë¡œ êµ¬ë§¤í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
            <p class="text-red-600 font-bold text-3xl mb-8"><span id="modal-price">0</span> <span class="text-lg text-gray-600">ì¿ í‚¤</span></p>
            <button onclick="confirmSinglePurchase()" class="w-full bg-blue-600 text-white py-4 rounded-xl font-bold text-xl hover:bg-blue-700 shadow-lg transition transform active:scale-[0.98]">êµ¬ë§¤í•˜ê¸°</button>
        </div>
    </div>
</div>

<!-- ì‹œí¬ë¦¿ ì¿ í° í™•ì¸ ëª¨ë‹¬ -->
<div id="modal-secret-coupon" class="fixed inset-0 bg-black/80 z-[80] hidden flex items-center justify-center p-4 backdrop-blur-sm animate-[fadeIn_0.2s_ease-out]">
    <div class="bg-white rounded-2xl w-full max-w-md p-6 shadow-2xl relative flex flex-col items-center">
        <button onclick="closeSecretModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-800 p-1"><i data-lucide="x" class="w-8 h-8"></i></button>
        <h3 class="font-bold text-xl mb-6 text-gray-800 mt-2">ğŸ« ë‚˜ì˜ ì¿ í°(ë°”ì½”ë“œ)</h3>
        <div class="w-full bg-gray-100 rounded-xl p-2 flex items-center justify-center border-2 border-dashed border-gray-300 min-h-[200px]">
            <img id="modal-secret-img" src="" class="max-w-full max-h-[60vh] object-contain rounded-lg shadow-sm">
        </div>
        <p class="text-center text-gray-500 text-sm mt-4">ì„ ìƒë‹˜ì´ë‚˜ ì‚¬ìš©ì²˜ì— ì´ í™”ë©´ì„ ë³´ì—¬ì£¼ì„¸ìš”.</p>
        <button onclick="closeSecretModal()" class="mt-6 w-full bg-blue-600 text-white py-3 rounded-xl font-bold text-lg hover:bg-blue-700 transition">ë‹«ê¸°</button>
    </div>
</div>

<!-- ì…ê³  ìš”ì²­ ëª¨ë‹¬ -->
<div id="modal-request" class="fixed inset-0 bg-black/60 z-[90] hidden flex items-center justify-center p-4 backdrop-blur-sm animate-[fadeIn_0.2s_ease-out]">
    <div class="bg-white rounded-2xl w-full max-w-sm p-6 shadow-2xl relative">
        <button onclick="closeRequestModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 p-1"><i data-lucide="x" class="w-6 h-6"></i></button>
        <h3 class="font-bold text-xl mb-4 text-gray-800 flex items-center gap-2"><i data-lucide="message-circle" class="w-6 h-6 text-indigo-500"></i> ì…ê³  ìš”ì²­í•˜ê¸°</h3>
        <p class="text-sm text-gray-500 mb-4">ë¨¹ê³  ì‹¶ì€ ê°„ì‹ì´ë‚˜ í•„ìš”í•œ ì¿ í°ì´ ìˆë‚˜ìš”?<br>ì„ ìƒë‹˜ê»˜ ê±´ì˜í•´ë³´ì„¸ìš”!</p>
        <textarea id="request-text" class="w-full border-2 border-indigo-100 rounded-xl p-3 h-32 focus:outline-none focus:border-indigo-500 resize-none text-base" placeholder="ì˜ˆ: ì´ˆì½”ìš°ìœ  ì…ê³ í•´ì£¼ì„¸ìš”!"></textarea>
        <button onclick="submitRequest()" class="w-full mt-4 bg-indigo-600 text-white py-3 rounded-xl font-bold hover:bg-indigo-700 transition">ì œì¶œí•˜ê¸°</button>
    </div>
</div>

<!-- ì •ì‚° ë„ìš°ë¯¸ ëª¨ë‹¬ -->
<div id="settlement-modal" class="fixed inset-0 bg-black/60 z-[120] hidden flex items-center justify-center p-4 backdrop-blur-sm">
    <div class="bg-white rounded-2xl w-full max-w-sm p-6 shadow-2xl relative h-[70vh] flex flex-col">
        <div class="flex justify-between items-center mb-4">
            <h3 class="font-bold text-lg text-gray-800 flex items-center gap-2"><i data-lucide="clipboard-list" class="w-5 h-5 text-blue-600"></i> ë¯¸ì •ì‚° ë‚´ì—­ì„œ</h3>
            <button onclick="closeSettlementModal()" class="text-gray-400 hover:text-gray-600"><i data-lucide="x" class="w-6 h-6"></i></button>
        </div>
        <div class="bg-blue-50 p-3 rounded-lg text-xs text-blue-800 mb-4">
            * <b>[ìŠ¹ì¸]</b>í–ˆì§€ë§Œ ì•„ì§ <b>[ì •ì‚°ì²˜ë¦¬]</b>í•˜ì§€ ì•Šì€ í•™ìƒ ëª©ë¡ì…ë‹ˆë‹¤.<br>
            * ì´ ë‚´ìš©ì„ ë³´ê³  <b>ë‹¤í–ˆë‹ˆ ì›¹ì‚¬ì´íŠ¸</b>ì—ì„œ ì¿ í‚¤ë¥¼ ì°¨ê°í•´ì£¼ì„¸ìš”.
        </div>
        <div id="settlement-list" class="flex-1 overflow-y-auto space-y-2 border-t border-b py-2"></div>
        <div class="pt-4">
            <button onclick="completeSettlement()" class="w-full bg-green-600 text-white py-3 rounded-xl font-bold hover:bg-green-700 shadow-md">ëª¨ë‘ ì •ì‚° ì™„ë£Œ ì²˜ë¦¬</button>
        </div>
    </div>
</div>

<script>
    const DEFAULT_PRODUCTS = [
        { id: 1, name: "ìë¦¬ ë°”ê¾¸ê¸° 1íšŒê¶Œ", basePrice: 50, img: "ğŸª‘", category: "íŠ¹ê¶Œ", discount: 0, stock: 99, expiryDays: 30 },
        { id: 2, name: "ê¸‰ì‹ 1ë“± ì‹ì‚¬ê¶Œ", basePrice: 30, img: "ğŸ±", category: "íŠ¹ê¶Œ", discount: 0, stock: 99, expiryDays: 30 },
        { id: 3, name: "ìˆ™ì œ 1íšŒ ë©´ì œê¶Œ", basePrice: 100, img: "ğŸŸï¸", category: "ë©´ì œ", discount: 0, stock: 99, expiryDays: 30 },
        { id: 4, name: "ëœë¤ ê°„ì‹ ë½‘ê¸°", basePrice: 15, img: "ğŸ¬", category: "ê°„ì‹", discount: 0, stock: 99, expiryDays: 30 },
        { id: 5, name: "ìœ íŠœë¸Œ DJ ì‹ ì²­ê³¡", basePrice: 10, img: "ğŸµ", category: "íŠ¹ê¶Œ", discount: 0, stock: 99, expiryDays: 30 },
        { id: 6, name: "ë³´ë“œê²Œì„ 30ë¶„ê¶Œ", basePrice: 40, img: "ğŸ²", category: "íŠ¹ê¶Œ", discount: 0, stock: 99, expiryDays: 30 }
    ];

    let PRODUCTS = [];
    let GLOBAL_DISCOUNT = 0;
    let ALL_ORDERS = [];
    let REQUESTS = []; 
    let ADMIN_PW = "1234";
    let API_KEY = ""; 
    let currentUser = null;
    let cart = [];
    let currentCategory = 'ALL';
    let currentModalItem = null;
    let editingProductIndex = -1;
    
    // ì´ë¯¸ì§€ ì—…ë¡œë“œ ë³€ìˆ˜
    let currentUploadImg = null;
    let currentSecretImages = []; 

    lucide.createIcons();
    loadData();

    function loadData() {
        try {
            const masterData = localStorage.getItem('dapang_products_master');
            if(masterData && masterData !== '[]') {
                PRODUCTS = JSON.parse(masterData);
            } else {
                PRODUCTS = JSON.parse(JSON.stringify(DEFAULT_PRODUCTS));
            }
            if (!Array.isArray(PRODUCTS)) PRODUCTS = JSON.parse(JSON.stringify(DEFAULT_PRODUCTS));

            PRODUCTS.forEach(p => { 
                if(typeof p.stock === 'undefined') p.stock = 99; 
                if(!p.img) p.img = "ğŸ";
                if(p.secretImg && (!p.secretImages || p.secretImages.length === 0)) {
                    p.secretImages = [p.secretImg];
                    delete p.secretImg;
                }
                if(!p.secretImages) p.secretImages = [];
                // [NEW] ìœ íš¨ê¸°ê°„ ë°ì´í„° ë³´ì •
                if(typeof p.expiryDays === 'undefined') p.expiryDays = 30;
            });

            GLOBAL_DISCOUNT = parseInt(localStorage.getItem('dapang_global_discount') || '0');
            ADMIN_PW = localStorage.getItem('dapang_admin_pw') || "1234";
            API_KEY = localStorage.getItem('dapang_api_key') || ""; 
            
            const ordersData = localStorage.getItem('dapang_all_orders');
            ALL_ORDERS = ordersData ? JSON.parse(ordersData) : [];
            ALL_ORDERS.forEach(o => { 
                if(o.status === 'completed' && typeof o.settled === 'undefined') o.settled = false;
                if(typeof o.used === 'undefined') o.used = false;
                if(typeof o.secretImg === 'undefined') o.secretImg = null; 
            });

            const reqData = localStorage.getItem('dapang_product_requests');
            REQUESTS = reqData ? JSON.parse(reqData) : [];

        } catch(e) {
            console.error("Load data error", e);
            PRODUCTS = JSON.parse(JSON.stringify(DEFAULT_PRODUCTS));
        }
    }

    function saveData() {
        localStorage.setItem('dapang_products_master', JSON.stringify(PRODUCTS));
        localStorage.setItem('dapang_all_orders', JSON.stringify(ALL_ORDERS));
        localStorage.setItem('dapang_product_requests', JSON.stringify(REQUESTS));
    }

    function loginDemo() { processLogin({ name: "ì²´í—˜í•™ìƒ", totalCookie: 300, badges: { "0": { title: "ëª¨ë²”ìƒ", hasBadge: true } } }, "demo"); }
    async function loginWithAPI() {
        const code = document.getElementById('student-code-input').value;
        if(!code) return alert("í•™ìƒ ì½”ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        if(!API_KEY) {
            if(confirm("API Keyê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì„¤ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ì·¨ì†Œ ì‹œ ë°ëª¨ ëª¨ë“œ)")) return alert("ìš°ì¸¡ ìƒë‹¨ í†±ë‹ˆë°”í€´ë¥¼ ëˆŒëŸ¬ API Keyë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            processLogin({ name: "í•™ìƒ " + code, totalCookie: 200 }, code); return;
        }
        const btn = document.querySelector('button[onclick="loginWithAPI()"]');
        const orgText = btn.innerText; btn.innerText = "ì¡°íšŒ ì¤‘...";
        try {
            const res = await fetch(`https://api.dahandin.com/openapi/v1/get/student/total?code=${code}`, { method: "GET", headers: { "X-API-Key": API_KEY } });
            const json = await res.json();
            if (json.result) processLogin(json.data, code); else alert("ë¡œê·¸ì¸ ì‹¤íŒ¨: " + json.message);
        } catch (e) { console.error(e); alert("í†µì‹ /ë°ì´í„° ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + e.message); } finally { btn.innerText = orgText; }
    }

    function processLogin(data, code) {
        const savedUser = JSON.parse(localStorage.getItem('dapang_user_' + code) || '{"spent":0, "cart":[]}');
        currentUser = { name: data.name, code: code, apiTotal: data.totalCookie || 0, spent: savedUser.spent, badges: data.badges || {} };
        cart = savedUser.cart || [];
        document.getElementById('login-section').classList.add('hidden');
        document.getElementById('tab-home').classList.remove('hidden');
        document.getElementById('bottom-nav').classList.remove('hidden');
        document.getElementById('bottom-nav').classList.add('flex');
        document.getElementById('user-status').classList.remove('hidden');
        updateHeader(); renderCategories(); renderProducts(); updateCartBadge(); updateBanner();
        lucide.createIcons();
    }

    function updateHeader() {
        const balance = (currentUser.apiTotal) - currentUser.spent;
        document.getElementById('my-cookie').innerText = balance.toLocaleString();
        document.getElementById('user-name-display').innerText = currentUser.name; 
        currentUser.discount = 0;
        if(currentUser.badges) { for(let k in currentUser.badges) { if(currentUser.badges[k].hasBadge) { currentUser.discount = 0.1; break; } } }
    }

    function renderCategories() {
        const container = document.getElementById('category-container'); if (!container) return;
        const cats = ['ALL', ...new Set(PRODUCTS.map(p => p.category))];
        container.innerHTML = cats.map(c => `<button onclick="filterCategory('${c}')" class="cat-btn px-5 py-2.5 border-2 border-gray-200 rounded-xl text-base font-bold whitespace-nowrap bg-white text-gray-600 transition shadow-sm hover:bg-gray-50 ${c===currentCategory?'active':''}">${c==='ALL'?'ì „ì²´ë³´ê¸°':c}</button>`).join('');
    }
    function filterCategory(cat) { currentCategory = cat; renderCategories(); renderProducts(); }
    function getImgHtml(imgStr) {
        if (!imgStr) return `<div class="w-full h-full flex items-center justify-center text-6xl">ğŸ</div>`;
        if (imgStr.startsWith('data:image')) return `<div class="prod-img-box w-full h-full overflow-hidden rounded-lg"><img src="${imgStr}"></div>`;
        return `<div class="w-full h-full flex items-center justify-center text-6xl">${imgStr}</div>`;
    }
    function updateBanner() {
        const banner = document.getElementById('smart-banner'); let maxDiscount = 0; 
        PRODUCTS.forEach(p => { const d = Math.max(p.discount || 0, GLOBAL_DISCOUNT); if(d > maxDiscount) maxDiscount = d; });
        if (maxDiscount > 0) { banner.classList.remove('hidden'); document.getElementById('banner-text').innerText = `ğŸ”¥ í˜„ì¬ ìµœëŒ€ ${maxDiscount}% ì„¸ì¼ ì§„í–‰ ì¤‘!`; } else { banner.classList.add('hidden'); }
    }

    function renderProducts(tgt='product-list', filter='') {
        const container = document.getElementById(tgt); if(!container) return; container.innerHTML = "";
        let list = currentCategory==='ALL' ? PRODUCTS : PRODUCTS.filter(p=>p.category===currentCategory);
        if(tgt!=='product-list') { list = PRODUCTS.filter(p=>p.name.includes(filter)); document.getElementById('no-search-result').classList.toggle('hidden', list.length>0); }
        
        list.forEach(p => {
            const discount = Math.max(p.discount || 0, GLOBAL_DISCOUNT);
            const price = discount > 0 ? Math.floor(p.basePrice * (1 - discount/100)) : p.basePrice;
            const isSoldOut = p.stock <= 0;
            const stockBadge = `<div class="absolute top-3 left-3 bg-gray-900/80 text-white text-xs font-bold px-2.5 py-1 rounded-full z-10 backdrop-blur-sm">ë‚¨ì€ìˆ˜ëŸ‰: ${p.stock}</div>`;
            const soldOutOverlay = isSoldOut ? `<div class="absolute inset-0 bg-black/50 rounded-xl z-20 flex items-center justify-center"><span class="text-white font-bold text-xl border-2 border-white px-3 py-1 rounded">SOLD OUT</span></div>` : '';

            const secretBadge = (p.secretImages && p.secretImages.length > 0) ? `<div class="absolute bottom-2 left-2 bg-yellow-400 text-yellow-900 text-[10px] font-bold px-2 py-1 rounded shadow-sm z-10">ğŸ« ì¿ í°</div>` : '';

            const el = document.createElement('div');
            el.className = "bg-white p-4 rounded-2xl border-2 border-gray-100 shadow-sm flex flex-col relative overflow-hidden group hover:border-blue-300 transition-all duration-300";
            el.innerHTML = `
                ${soldOutOverlay}
                ${stockBadge}
                ${!isSoldOut && discount>0 ? `<div class="absolute top-0 right-0 bg-red-600 text-white text-sm font-bold px-3 py-1.5 rounded-bl-xl rounded-tr-xl z-10 shadow-md">${discount}% SALE</div>` : ''}
                <div class="w-full h-32 bg-gray-50 rounded-xl mb-4 flex items-center justify-center overflow-hidden group-hover:scale-105 transition-transform duration-300 relative">
                    ${getImgHtml(p.img)}
                    ${secretBadge}
                </div>
                <div class="absolute top-36 right-3 text-[10px] text-gray-500 bg-gray-100 px-2 py-0.5 rounded font-bold">${p.category}</div>
                <h3 class="font-bold text-gray-800 text-lg mb-1 truncate">${p.name}</h3>
                <div class="mt-auto">
                    <div class="flex items-center gap-2 mb-3">
                        ${!isSoldOut && discount>0 ? `<span class="price-strike text-gray-400 font-medium">${p.basePrice}</span>` : ''}
                        <span class="text-red-600 font-bold text-2xl">${price}</span><span class="text-sm text-gray-500 font-bold mt-1">ì¿ í‚¤</span>
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                        <button onclick="${isSoldOut ? '' : `addToCart(${p.id}, '${p.name}', ${price}, '${p.img}', this)`}" class="border-2 border-blue-600 text-blue-600 py-2.5 rounded-xl font-bold text-sm hover:bg-blue-50 disabled:opacity-50 transition" ${isSoldOut?'disabled':''}>ì¥ë°”êµ¬ë‹ˆ</button>
                        <button onclick="${isSoldOut ? '' : `openPurchaseModal('${p.name}', ${price}, ${p.id}, '${p.img}')`}" class="bg-blue-600 text-white py-2.5 rounded-xl font-bold text-sm hover:bg-blue-700 disabled:opacity-50 shadow-md transition" ${isSoldOut?'disabled':''}>ë°”ë¡œêµ¬ë§¤</button>
                    </div>
                </div>`;
            container.appendChild(el);
        });
    }

    function addToCart(id, name, price, img, btn) {
        const prod = PRODUCTS.find(p => p.id === id);
        if(!prod || prod.stock <= 0) return alert("ì¬ê³ ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.");
        const inCart = cart.find(i => i.id === id);
        if(inCart && inCart.quantity >= prod.stock) return alert("ë‚¨ì€ ì¬ê³ ë³´ë‹¤ ë§ì´ ë‹´ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        if(inCart) inCart.quantity++; else cart.push({id, name, price, img, quantity:1});
        saveUser(); updateCartBadge(); btn.innerText="ë‹´ê¹€!"; setTimeout(()=>{btn.innerText="ì¥ë°”êµ¬ë‹ˆ"},500);
    }

    function checkoutCart() {
        for (const item of cart) { const prod = PRODUCTS.find(p => p.id === item.id); if (!prod || prod.stock < item.quantity) return alert(`'${item.name}' ì¬ê³  ë¶€ì¡±!`); }
        let totalCookie = 0; let totalCount = 0; cart.forEach(i => { totalCookie += (i.price * i.quantity); totalCount += i.quantity; });
        const balance = (currentUser.apiTotal - currentUser.spent);
        if(balance < totalCookie) { alert(`ì¿ í‚¤ ë¶€ì¡±! (ë¶€ì¡±: ${totalCookie - balance})`); return; }
        if(confirm(`ì´ ${totalCount}ê°œ ìƒí’ˆ ì£¼ë¬¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (${totalCookie} ì¿ í‚¤)`)) {
            const now = new Date().toLocaleString();
            cart.forEach(item => { 
                const prod = PRODUCTS.find(p => p.id === item.id);
                for(let i=0; i<item.quantity; i++) { 
                    currentUser.spent += item.price; 
                    ALL_ORDERS.push({ 
                        id: Date.now() + Math.random(), 
                        studentCode: currentUser.code, 
                        studentName: currentUser.name, 
                        name: item.name, 
                        price: item.price, 
                        img: item.img, 
                        secretImg: null, 
                        date: now, 
                        status: 'pending', 
                        productId: item.id, 
                        settled: false, 
                        used: false 
                    }); 
                } 
            });
            cart = []; saveUser(); saveData(); updateHeader(); updateCartBadge(); closeCart(); switchTab('history'); setTimeout(() => { alert("ì£¼ë¬¸ ì™„ë£Œ! ğŸšš"); }, 100);
        }
    }

    function switchTab(tabId) {
        document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden')); document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active')); document.getElementById('tab-' + tabId).classList.remove('hidden'); document.getElementById('nav-' + tabId).classList.add('active');
        if(tabId === 'history') renderHistory(); if(tabId === 'search') document.getElementById('search-input').focus(); if(tabId === 'home') updateBanner(); window.scrollTo(0,0);
    }

    function renderHistory() {
        const list = document.getElementById('history-list'); if (!currentUser) return;
        const myOrders = ALL_ORDERS.filter(o => o.studentCode === currentUser.code).reverse();
        if(myOrders.length === 0) { list.innerHTML = "<div class='text-center text-gray-400 py-20 bg-white rounded-2xl shadow-sm border border-gray-100'><i class='lucide-clipboard-list w-12 h-12 mx-auto mb-2 opacity-20'></i><p>ì£¼ë¬¸ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</p></div>"; return; }
        
        list.innerHTML = myOrders.map(h => {
            const isPending = h.status === 'pending';
            const statusBadge = isPending ? `<span class="bg-yellow-100 text-yellow-700 text-xs font-bold px-2.5 py-1 rounded-full border border-yellow-200 animate-pulse flex items-center gap-1">ğŸšš ë°°ì†¡ì¤‘</span>` : (h.status==='rejected' ? `<span class="bg-red-100 text-red-700 text-xs font-bold px-2.5 py-1 rounded-full border border-red-200">ğŸš« ì·¨ì†Œë¨</span>` : `<span class="bg-green-100 text-green-700 text-xs font-bold px-2.5 py-1 rounded-full border border-green-200 flex items-center gap-1"><i class="lucide-check w-3 h-3"></i> ë°°ì†¡ì™„ë£Œ</span>`);
            const cancelBtn = isPending ? `<button onclick="cancelOrder(${h.id})" class="mt-3 text-xs bg-white text-gray-500 px-3 py-1.5 rounded-lg border border-gray-200 hover:bg-gray-50 font-bold w-full transition">ì£¼ë¬¸ì·¨ì†Œ</button>` : ``;
            
            let secretBtn = '';
            if (h.status === 'completed' && h.secretImg) {
                secretBtn = `<button onclick="showSecretCoupon('${h.id}')" class="mt-2 w-full bg-yellow-400 text-yellow-900 text-xs font-bold py-2 rounded-lg hover:bg-yellow-500 shadow-sm transition flex items-center justify-center gap-1"><i data-lucide="ticket" class="w-4 h-4"></i> ì¿ í° í™•ì¸í•˜ê¸°</button>`;
            }
            
            // ë§Œë£Œì¼ í‘œì‹œ (ìˆëŠ” ê²½ìš°)
            const expiryText = h.expiryDate ? `<p class="text-[10px] text-gray-400">ìœ íš¨ê¸°ê°„: ${h.expiryDate}ê¹Œì§€</p>` : '';

            return `<div class="bg-white p-5 rounded-2xl border border-gray-100 shadow-sm flex justify-between items-center">
                        <div class="flex items-center gap-4">
                            <div class="w-14 h-14 flex items-center justify-center bg-gray-50 rounded-xl overflow-hidden text-3xl shadow-inner">${getImgHtml(h.img)}</div>
                            <div>
                                <div class="flex items-center gap-2"><p class="font-bold text-gray-800 text-base">${h.name}</p></div>
                                <p class="text-xs text-gray-400 mt-1">${h.date}</p>
                                ${expiryText}
                                <div class="mt-2">${statusBadge}</div>
                            </div>
                        </div>
                        <div class="text-right flex flex-col items-end min-w-[100px]">
                            <p class="text-red-600 font-bold text-lg">-${h.price} <span class="text-xs text-gray-500">ì¿ í‚¤</span></p>
                            ${cancelBtn}
                            ${secretBtn}
                        </div>
                    </div>`;
        }).join('');
        lucide.createIcons();
    }

    function showSecretCoupon(orderId) {
        const order = ALL_ORDERS.find(o => o.id == orderId);
        if (!order || !order.secretImg) return alert("ì¿ í° ì´ë¯¸ì§€ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        document.getElementById('modal-secret-img').src = order.secretImg;
        document.getElementById('modal-secret-coupon').classList.remove('hidden');
    }

    function closeSecretModal() {
        document.getElementById('modal-secret-coupon').classList.add('hidden');
    }

    function openRequestModal() {
        document.getElementById('modal-request').classList.remove('hidden');
        document.getElementById('request-text').value = '';
        document.getElementById('request-text').focus();
    }

    function closeRequestModal() {
        document.getElementById('modal-request').classList.add('hidden');
    }

    function submitRequest() {
        const text = document.getElementById('request-text').value.trim();
        if(!text) return alert("ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        
        REQUESTS.push({
            id: Date.now(),
            text: text,
            date: new Date().toLocaleDateString()
        });
        saveData();
        
        closeRequestModal();
        alert("ì…ê³  ìš”ì²­ì´ ì„ ìƒë‹˜ê»˜ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ“¨");
    }

    function openAdmin() {
        const inputPw = prompt(ADMIN_PW === "1234" ? "ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš” (ê¸°ë³¸: 1234)" : "ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”");
        if (inputPw !== ADMIN_PW) { alert("ë¹„ë°€ë²ˆí˜¸ ë¶ˆì¼ì¹˜"); return; }
        const adminSection = document.getElementById('section-admin'); adminSection.classList.remove('hidden'); adminSection.scrollTop = 0; 
        loadData(); document.getElementById('global-discount-input').value = GLOBAL_DISCOUNT; document.getElementById('dahandin-api-key').value = API_KEY; 
        switchAdminTab('products'); renderAdminList(); updateCategoryOptions(); renderCategoryChips(); cancelEdit();
    }
    function saveApiKey() { const key = document.getElementById('dahandin-api-key').value; if(!key) return alert("API Keyë¥¼ ì…ë ¥í•˜ì„¸ìš”."); API_KEY = key; localStorage.setItem('dapang_api_key', API_KEY); alert("ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤."); }
    function closeAdmin() { document.getElementById('section-admin').classList.add('hidden'); loadData(); renderCategories(); renderProducts(); updateBanner(); }
    
    function switchAdminTab(tab) { 
        document.getElementById('admin-tab-products').classList.add('hidden'); 
        document.getElementById('admin-tab-orders').classList.add('hidden'); 
        document.getElementById('admin-tab-requests').classList.add('hidden'); 
        
        ['products', 'orders', 'requests'].forEach(t => {
            document.getElementById(`admin-tab-btn-${t}`).className = "flex-1 py-3 rounded-lg text-gray-500 text-sm font-bold hover:bg-gray-200 transition";
        });

        document.getElementById(`admin-tab-${tab}`).classList.remove('hidden'); 
        document.getElementById(`admin-tab-btn-${tab}`).className = "flex-1 py-3 rounded-lg bg-white shadow-sm text-sm font-bold transition"; 
        
        if(tab === 'orders') renderAdminOrders(); 
        if(tab === 'products') renderAdminList(); 
        if(tab === 'requests') renderRequestList(); 
    }

    function renderRequestList() {
        const list = document.getElementById('admin-request-list');
        if(!REQUESTS || REQUESTS.length === 0) {
            list.innerHTML = "";
            document.getElementById('admin-request-empty').classList.remove('hidden');
            return;
        }
        document.getElementById('admin-request-empty').classList.add('hidden');
        const sorted = [...REQUESTS].sort((a,b) => b.id - a.id);
        
        list.innerHTML = sorted.map((req, idx) => `
            <div class="bg-white p-4 rounded-xl border border-indigo-100 shadow-sm flex justify-between items-start gap-4">
                <div class="flex-1">
                    <p class="text-gray-800 text-base font-medium whitespace-pre-wrap">${req.text}</p>
                    <p class="text-xs text-gray-400 mt-2">${req.date}</p>
                </div>
                <button onclick="deleteRequest(${req.id})" class="text-red-400 hover:text-red-600 p-1 rounded-full hover:bg-red-50 transition" title="ì‚­ì œ">
                    <i data-lucide="trash-2" class="w-5 h-5"></i>
                </button>
            </div>
        `).join('');
        lucide.createIcons();
    }

    function deleteRequest(id) {
        if(confirm("ì´ ìš”ì²­ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
            const idx = REQUESTS.findIndex(r => r.id === id);
            if(idx > -1) {
                REQUESTS.splice(idx, 1);
                saveData();
                renderRequestList();
            }
        }
    }
    
    function renderAdminList() { 
        const list = document.getElementById('admin-prod-list');
        if (!PRODUCTS || PRODUCTS.length === 0) { list.innerHTML = `<div class="text-center text-gray-400 py-10 bg-gray-50 rounded-lg border border-dashed border-gray-200">ë“±ë¡ëœ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤.</div>`; return; }
        list.innerHTML = PRODUCTS.map((p,i)=> {
            const secretIcon = (p.secretImages && p.secretImages.length > 0) ? `<span class="text-xs bg-yellow-100 text-yellow-700 px-1.5 rounded border border-yellow-200 ml-1">ğŸ« x${p.secretImages.length}</span>` : '';
            return `<div class="bg-white p-4 rounded-xl border border-gray-200 shadow-sm mb-3 hover:border-blue-300 transition"><div class="flex gap-4 items-center"><div class="w-12 h-12 flex items-center justify-center bg-gray-50 rounded-lg overflow-hidden text-2xl">${getImgHtml(p.img)}</div><div><p class="font-bold text-sm text-gray-800 flex items-center">${p.name} ${secretIcon}</p><p class="text-xs text-gray-500">${p.basePrice}ì¿ í‚¤ | ì¬ê³ : ${p.stock}</p></div></div><div class="flex gap-2"><button onclick="editProduct(${i})" class="text-blue-600 bg-blue-50 px-3 py-1.5 rounded-lg text-xs font-bold hover:bg-blue-100 transition">ìˆ˜ì •</button><button onclick="deleteProduct(${i})" class="text-red-500 bg-red-50 px-3 py-1.5 rounded-lg text-xs font-bold hover:bg-red-100 transition">ì‚­ì œ</button></div></div>`;
        }).join(''); 
    }

    function renderAdminOrders() { 
        const list = document.getElementById('admin-order-list'); const pendingOrders = ALL_ORDERS.filter(o => o.status === 'pending'); 
        if(pendingOrders.length === 0) { list.innerHTML = ""; document.getElementById('admin-order-empty').classList.remove('hidden'); }
        else { document.getElementById('admin-order-empty').classList.add('hidden'); list.innerHTML = pendingOrders.map(o => `<div class="bg-white p-4 rounded-xl border border-gray-200 shadow-sm flex justify-between items-center"><div class="flex items-center gap-3"><div class="text-3xl bg-gray-50 rounded-lg w-12 h-12 flex items-center justify-center overflow-hidden">${getImgHtml(o.img).replace('class="', 'class="w-full h-full object-cover ')}</div><div><p class="font-bold text-sm text-gray-800"><span class="text-blue-600 font-extrabold">[${o.studentName}]</span> ${o.name}</p><p class="text-xs text-gray-400 mt-1">${o.date}</p></div></div><div class="flex gap-2"><button onclick="rejectOrder(${o.id})" class="bg-red-100 text-red-600 px-4 py-2 rounded-lg text-xs font-bold hover:bg-red-200 transition">ì·¨ì†Œ</button><button onclick="confirmOrder(${o.id})" class="bg-blue-600 text-white px-4 py-2 rounded-lg text-xs font-bold hover:bg-blue-700 shadow-md transition">ìŠ¹ì¸</button></div></div>`).join(''); }
        renderCompletedOrders(1);
    }

    function renderCompletedOrders(page = 1) {
        const list = document.getElementById('admin-completed-list'); const pagination = document.getElementById('order-pagination'); const searchText = document.getElementById('order-search').value.toLowerCase();
        let completed = ALL_ORDERS.filter(o => o.status === 'completed' || o.status === 'rejected');
        if(searchText) { completed = completed.filter(o => (o.studentName && o.studentName.toLowerCase().includes(searchText)) || (o.name && o.name.toLowerCase().includes(searchText))); }
        completed.sort((a,b) => b.id - a.id);
        const perPage = 5; const totalPages = Math.ceil(completed.length / perPage); const start = (page - 1) * perPage; const end = start + perPage; const pageItems = completed.slice(start, end);
        if (pageItems.length === 0) { list.innerHTML = `<div class="text-center text-xs text-gray-400 py-4">ì™„ë£Œëœ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</div>`; pagination.innerHTML = ""; return; }
        
        list.innerHTML = pageItems.map(o => `
            <div class="bg-gray-50 p-3 rounded-xl border border-gray-100 flex justify-between items-center opacity-90 hover:opacity-100 transition">
                <div class="flex items-center gap-3">
                    <div class="text-base opacity-60 bg-white rounded p-1 w-8 h-8 flex items-center justify-center overflow-hidden">${getImgHtml(o.img).replace('text-6xl', 'text-base').replace('class="', 'class="w-full h-full object-cover ')}</div>
                    <div>
                        <p class="font-bold text-sm text-gray-700"><span class="text-gray-500 mr-1">[${o.studentName}]</span> ${o.name}</p>
                        <p class="text-[10px] text-gray-400 mt-0.5">${o.date} | ${o.status==='rejected'?'<span class="text-red-500 font-bold">ì·¨ì†Œë¨</span>':'<span class="text-green-600 font-bold">ë°°ì†¡ì™„ë£Œ</span>'}</p>
                    </div>
                </div>
                <div class="flex items-center gap-2">
                    ${o.status === 'completed' ? (o.used ? `<span class="bg-red-500 text-white text-[10px] font-bold px-2 py-1 rounded-lg">ì‚¬ìš©ì™„ë£Œ</span>` : `<button onclick="markAsUsed(${o.id})" class="bg-blue-100 text-blue-600 text-[10px] font-bold px-2 py-1 rounded-lg hover:bg-blue-200">ì‚¬ìš©í•˜ê¸°</button>`) : ''}
                    <div class="text-gray-500 text-xs font-bold bg-white px-2 py-1 rounded border border-gray-200">-${o.price}</div>
                </div>
            </div>
        `).join('');
        let pagesHtml = ""; for(let i=1; i<=totalPages; i++) { pagesHtml += `<button onclick="renderCompletedOrders(${i})" class="w-8 h-8 rounded-lg border font-bold text-xs transition ${i===page ? 'bg-blue-600 text-white border-blue-600' : 'bg-white text-gray-500 hover:bg-gray-50'}">${i}</button>`; } pagination.innerHTML = pagesHtml;
    }

    function markAsUsed(id) {
        const order = ALL_ORDERS.find(o => o.id === id);
        if (order) {
            if (confirm("ì´ ì¿ í°ì„ 'ì‚¬ìš© ì™„ë£Œ' ì²˜ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                order.used = true;
                saveData();
                renderCompletedOrders(1); 
            }
        }
    }

    function openSettlementModal() {
        document.getElementById('settlement-modal').classList.remove('hidden');
        const list = document.getElementById('settlement-list');
        const settledData = {}; 
        ALL_ORDERS.forEach(o => {
            if (o.status === 'completed' && !o.settled) {
                if (!settledData[o.studentName]) settledData[o.studentName] = 0;
                settledData[o.studentName] += o.price;
            }
        });
        if (Object.keys(settledData).length === 0) { list.innerHTML = `<div class="text-center py-10 text-gray-400">ëª¨ë‘ ì •ì‚°ë˜ì—ˆìŠµë‹ˆë‹¤.</div>`; return; }
        let html = "";
        for (const [name, total] of Object.entries(settledData)) {
            html += `<div class="flex justify-between items-center bg-gray-50 p-3 rounded-lg"><span class="font-bold text-gray-800">${name}</span><span class="text-red-600 font-bold">-${total} ì¿ í‚¤</span></div>`;
        }
        list.innerHTML = html;
    }

    function closeSettlementModal() { document.getElementById('settlement-modal').classList.add('hidden'); }

    function completeSettlement() {
        if(confirm("í˜„ì¬ ëª©ë¡ì˜ ì¿ í‚¤ë¥¼ ë‹¤í–ˆë‹ˆ ì‚¬ì´íŠ¸ì—ì„œ ì°¨ê°í•˜ì…¨ìŠµë‹ˆê¹Œ?\ní™•ì¸ì„ ëˆ„ë¥´ë©´ 'ì •ì‚° ì™„ë£Œ' ì²˜ë¦¬ë˜ì–´ ëª©ë¡ì—ì„œ ì‚¬ë¼ì§‘ë‹ˆë‹¤.")) {
            ALL_ORDERS.forEach(o => { if (o.status === 'completed' && !o.settled) o.settled = true; });
            saveData();
            closeSettlementModal();
            alert("ì •ì‚° ì™„ë£Œ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.");
        }
    }

    function confirmOrder(id) { 
        const order = ALL_ORDERS.find(o => o.id === id); 
        if(!order) return; 
        
        const prodIndex = PRODUCTS.findIndex(p => p.id === order.productId || p.name === order.name); 
        
        if (prodIndex > -1) { 
            const product = PRODUCTS[prodIndex];
            
            // ì‹œí¬ë¦¿ ì¿ í° ë°œì†¡ ë¡œì§
            if (product.secretImages && product.secretImages.length > 0) {
                if (product.secretImages.length === 0) {
                    return alert("ì¿ í°(ë°”ì½”ë“œ) ì´ë¯¸ì§€ê°€ ëª¨ë‘ ì†Œì§„ë˜ì—ˆìŠµë‹ˆë‹¤! ë” ì´ìƒ ìŠ¹ì¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                }
                const assignedCoupon = product.secretImages.shift();
                order.secretImg = assignedCoupon;
                product.stock = product.secretImages.length;
            } 
            else {
                if (product.stock > 0) { 
                    product.stock--; 
                } else { 
                    return alert("ì¬ê³  ë¶€ì¡±!"); 
                } 
            }

            // [NEW] ìœ íš¨ê¸°ê°„ ë¡œì§ ì¶”ê°€
            const today = new Date();
            const expiryDate = new Date();
            // ìƒí’ˆì˜ expiryDays ì‚¬ìš© (ì—†ìœ¼ë©´ ê¸°ë³¸ê°’ 30)
            const daysToAdd = parseInt(product.expiryDays || 30);
            expiryDate.setDate(today.getDate() + daysToAdd);
            order.expiryDate = expiryDate.toLocaleDateString();

            order.status = 'completed'; 
            saveData(); 
            renderAdminOrders();
            
            if(product.secretImages && order.secretImg) {
                alert(`ì¿ í°ì´ ìë™ ë°œì†¡ë˜ì—ˆìŠµë‹ˆë‹¤. (ë‚¨ì€ ì¿ í°: ${product.stock}ê°œ)`);
            }
        } else { 
            if(confirm("ìƒí’ˆì´ ëª©ë¡ì—ì„œ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤. ê°•ì œë¡œ ìŠ¹ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) { 
                order.status = 'completed'; 
                saveData(); 
                renderAdminOrders(); 
            } 
        } 
    }

    function rejectOrder(id) { if(confirm("ì£¼ë¬¸ì·¨ì†Œ í•˜ê² ìŠµë‹ˆê¹Œ? (í•™ìƒì—ê²Œ í™˜ë¶ˆë©ë‹ˆë‹¤)")) { const index = ALL_ORDERS.findIndex(o => o.id === id); if(index > -1) { ALL_ORDERS.splice(index, 1); currentUser.spent -= ALL_ORDERS[index].price; saveData(); saveUser(); renderAdminOrders(); alert("ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤."); } } }
    function cancelOrder(id) { if(confirm("ì·¨ì†Œ?")) { const idx = ALL_ORDERS.findIndex(o => o.id === id); if(idx > -1 && ALL_ORDERS[idx].status==='pending') { currentUser.spent -= ALL_ORDERS[idx].price; ALL_ORDERS.splice(idx, 1); saveUser(); saveData(); updateHeader(); renderHistory(); alert("ì·¨ì†Œë¨"); } } }
    function changeAdminPw() { const newPw = document.getElementById('new-admin-pw').value; if(!newPw) return; ADMIN_PW = newPw; localStorage.setItem('dapang_admin_pw', ADMIN_PW); alert("ë³€ê²½ë¨"); document.getElementById('new-admin-pw').value=""; }
    function openCart() { document.getElementById('section-cart').classList.remove('hidden'); renderCart(); window.scrollTo(0,0); }
    function closeCart() { document.getElementById('section-cart').classList.add('hidden'); }
    function renderCart() { const list = document.getElementById('cart-list'); list.innerHTML = ""; let total = 0; if(cart.length===0) { document.getElementById('cart-empty').classList.remove('hidden'); document.getElementById('cart-checkout-bar').classList.add('hidden'); return; } document.getElementById('cart-empty').classList.add('hidden'); document.getElementById('cart-checkout-bar').classList.remove('hidden'); cart.forEach((item,idx) => { total += item.price * item.quantity; list.innerHTML += `<div class="bg-white p-4 rounded-xl border border-gray-200 flex items-center justify-between shadow-sm"><div class="flex items-center gap-4 flex-1"><div class="w-12 h-12 flex items-center justify-center bg-gray-50 rounded text-2xl">${getImgHtml(item.img)}</div><div class="flex-1"><p class="font-bold text-gray-800">${item.name}</p><div class="flex justify-between mt-1"><span class="bg-blue-100 text-blue-600 text-xs px-2 py-1 rounded">x ${item.quantity}</span><span class="text-red-600 font-bold">${item.price*item.quantity} ì¿ í‚¤</span></div></div></div><button onclick="cart.splice(${idx},1);saveUser();renderCart();updateCartBadge()" class="text-gray-400 hover:text-red-500 p-2"><i data-lucide="trash-2"></i></button></div>`; }); document.getElementById('cart-total').innerText = total.toLocaleString(); lucide.createIcons(); }
    function removeFromCart(idx) { cart.splice(idx, 1); saveUser(); renderCart(); updateCartBadge(); }
    function openPurchaseModal(name, price, id, img) { currentModalItem = { name, price, id, img }; document.getElementById('modal-title').innerText = name; document.getElementById('modal-price').innerText = price; const imgContainer = document.getElementById('modal-img-area'); imgContainer.innerHTML = getImgHtml(img); if(img.startsWith('data:image')) { imgContainer.className = "w-24 h-24 rounded-lg mx-auto mb-4 overflow-hidden bg-white border border-gray-100 shadow-sm"; } else { imgContainer.className = "w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-6 text-5xl bg-blue-50"; } document.getElementById('modal-backdrop').classList.remove('hidden'); }
    function closeModal() { document.getElementById('modal-backdrop').classList.add('hidden'); }
    
    function confirmSinglePurchase() { 
        if(!currentUser || !currentModalItem) return; 
        const prod = PRODUCTS.find(p => p.id === currentModalItem.id); 
        if(!prod || prod.stock <= 0) { alert("ì¬ê³  ë¶€ì¡±!"); closeModal(); return; } 
        const balance = (currentUser.apiTotal - currentUser.spent); 
        if(balance < currentModalItem.price) { alert("ì¿ í‚¤ ë¶€ì¡±!"); closeModal(); return; } 
        currentUser.spent += currentModalItem.price; 
        
        ALL_ORDERS.push({ 
            id: Date.now(), 
            studentCode: currentUser.code, 
            studentName: currentUser.name, 
            name: currentModalItem.name, 
            price: currentModalItem.price, 
            img: currentModalItem.img, 
            secretImg: null, 
            date: new Date().toLocaleString(), 
            status: 'pending', 
            productId: currentModalItem.id, 
            settled: false 
        }); 
        saveUser(); saveData(); updateHeader(); closeModal(); switchTab('history'); setTimeout(() => { alert("ì£¼ë¬¸ ì™„ë£Œ! ğŸšš"); }, 100); 
    }

    function updateCartBadge() { const c=cart.reduce((a,b)=>a+b.quantity,0); document.getElementById('nav-cart-badge').innerText=c; document.getElementById('nav-cart-badge').classList.toggle('hidden', c===0); }
    function updateCategoryOptions() { document.getElementById('category-options').innerHTML=[...new Set(PRODUCTS.map(p=>p.category))].map(c=>`<option value="${c}">`).join(''); }
    
    // [NEW] ì¹´í…Œê³ ë¦¬ ì¹© ë Œë”ë§ (ì—…ë°ì´íŠ¸ëœ ë¡œì§)
    function renderCategoryChips() {
        const uniqueCats = [...new Set(PRODUCTS.map(p => p.category))].filter(Boolean);
        const area = document.getElementById('category-chip-area'); // ë‹¨ìˆ˜í˜• ID ì‚¬ìš©
        if(!area) return;
        
        if(uniqueCats.length === 0) {
            area.innerHTML = "";
            return;
        }

        area.innerHTML = uniqueCats.map(c => 
            `<button onclick="document.getElementById('new-prod-cat').value='${c}'" 
              class="px-3 py-1 bg-gray-100 hover:bg-gray-200 text-gray-600 text-xs font-bold rounded-full transition border border-gray-200">
              #${c}
            </button>`
        ).join('');
    }

    function previewImage(input) { if(input.files && input.files[0]) { const reader=new FileReader(); reader.onload=e=>{currentUploadImg=e.target.result; document.getElementById('img-preview').src=currentUploadImg; document.getElementById('img-preview-area').classList.remove('hidden');}; reader.readAsDataURL(input.files[0]); } }
    function clearImage() { currentUploadImg=null; document.getElementById('new-prod-img-file').value=""; document.getElementById('img-preview-area').classList.add('hidden'); }
    
    async function previewSecretImage(input) { 
        if (!input.files || input.files.length === 0) return;
        currentSecretImages = []; 
        const files = Array.from(input.files);
        const readPromises = files.map(file => {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = (e) => resolve(e.target.result);
                reader.readAsDataURL(file);
            });
        });
        try {
            currentSecretImages = await Promise.all(readPromises);
            renderSecretPreview();
        } catch(e) {
            console.error(e);
            alert("ì´ë¯¸ì§€ ë¡œë”© ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        }
    }

    function renderSecretPreview() {
        const box = document.getElementById('secret-img-preview-box');
        if (currentSecretImages.length === 0) {
            box.classList.add('hidden');
            return;
        }
        box.classList.remove('hidden');
        let html = `<div class="text-xs text-center text-gray-500 mb-2 font-bold sticky top-0 bg-white py-1 border-b">ì´ ${currentSecretImages.length}ê°œì˜ ì¿ í° ì´ë¯¸ì§€ ì„ íƒë¨</div>`;
        html += `<div class="grid grid-cols-4 gap-2">`;
        currentSecretImages.forEach((img, idx) => {
            html += `<div class="aspect-square bg-gray-100 rounded overflow-hidden border relative group">
                        <img src="${img}" class="w-full h-full object-cover">
                        <div class="absolute inset-0 bg-black/10 flex items-center justify-center text-[10px] text-white font-bold opacity-0 group-hover:opacity-100 transition">#${idx+1}</div>
                     </div>`;
        });
        html += `</div>`;
        html += `<button onclick="clearSecretImage()" class="absolute top-2 right-2 bg-gray-800 text-white rounded-full p-1 w-6 h-6 flex items-center justify-center text-xs hover:bg-black z-10">x</button>`;
        box.innerHTML = html;
        if(currentSecretImages.length > 0) {
            document.getElementById('new-prod-stock').value = currentSecretImages.length;
            document.getElementById('new-prod-stock').disabled = true; 
            document.getElementById('new-prod-stock').title = "ì‹œí¬ë¦¿ ëª¨ë“œì—ì„œëŠ” ì—…ë¡œë“œëœ ì´ë¯¸ì§€ ê°œìˆ˜ë¡œ ì¬ê³ ê°€ ê³ ì •ë©ë‹ˆë‹¤.";
        }
    }

    function clearSecretImage() { 
        currentSecretImages = []; 
        document.getElementById('secret-img-file').value=""; 
        document.getElementById('secret-img-preview-box').classList.add('hidden');
        document.getElementById('new-prod-stock').disabled = false; 
    }
    
    function toggleSecretMode() { 
        const isSecret = document.getElementById('is-secret-mode').checked; 
        document.getElementById('secret-img-area').classList.toggle('hidden', !isSecret);
        if(!isSecret) clearSecretImage();
        else if(currentSecretImages.length > 0) {
             document.getElementById('new-prod-stock').value = currentSecretImages.length;
             document.getElementById('new-prod-stock').disabled = true;
        }
    }

    function deleteProduct(i) { if(confirm("ì‚­ì œ?")) { PRODUCTS.splice(i,1); saveData(); renderAdminList(); } }
    function saveUser() { localStorage.setItem('dapang_user_'+currentUser.code, JSON.stringify({spent:currentUser.spent, cart:cart})); }
    function resetProducts() { if(confirm("ì´ˆê¸°í™”?")) { localStorage.clear(); location.reload(); } }
    function applyGlobalDiscount(v) { GLOBAL_DISCOUNT=v; localStorage.setItem('dapang_global_discount', GLOBAL_DISCOUNT); alert(`ì „ì²´ í• ì¸ìœ¨ì´ ${v}%ë¡œ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤.`); }
    function filterProducts() { renderProducts('search-results', document.getElementById('search-input').value); }
    
    function editProduct(i) { 
        editingProductIndex=i; const p=PRODUCTS[i]; 
        document.getElementById('new-prod-name').value=p.name; 
        document.getElementById('new-prod-price').value=p.basePrice; 
        document.getElementById('new-prod-cat').value=p.category; 
        document.getElementById('new-prod-stock').value=p.stock; 
        document.getElementById('new-prod-discount').value=p.discount||0; 
        // [NEW] ìœ íš¨ê¸°ê°„ ë¡œë“œ
        document.getElementById('new-prod-expiry').value = p.expiryDays || 30;
        
        if(p.img.startsWith('data:image')) { currentUploadImg=p.img; document.getElementById('img-preview').src=p.img; document.getElementById('img-preview-area').classList.remove('hidden'); } 
        else document.getElementById('new-prod-icon').value=p.img; 
        
        if(p.secretImages && p.secretImages.length > 0) {
            document.getElementById('is-secret-mode').checked = true;
            document.getElementById('secret-img-area').classList.remove('hidden'); 
            currentSecretImages = []; 
            const box = document.getElementById('secret-img-preview-box');
            box.classList.remove('hidden');
            box.innerHTML = `<div class="p-4 text-center bg-gray-50 rounded-lg border border-gray-200">
                                <p class="text-sm font-bold text-gray-700">í˜„ì¬ ${p.secretImages.length}ì¥ì˜ ì¿ í°ì´ ì €ì¥ë˜ì–´ ìˆìŠµë‹ˆë‹¤.</p>
                                <p class="text-xs text-gray-400 mt-1">ì¶”ê°€/ë³€ê²½í•˜ë ¤ë©´ ìœ„ ë²„íŠ¼ì„ ëˆŒëŸ¬ ì´ë¯¸ì§€ë¥¼ ìƒˆë¡œ ì—…ë¡œë“œí•˜ì„¸ìš”.<br>(ìƒˆë¡œ ì—…ë¡œë“œ ì‹œ ê¸°ì¡´ ì¿ í°ì€ ì‚­ì œë©ë‹ˆë‹¤)</p>
                             </div>`;
            document.getElementById('new-prod-stock').value = p.stock;
            document.getElementById('new-prod-stock').disabled = true;
        } else {
            document.getElementById('is-secret-mode').checked = false;
            document.getElementById('secret-img-area').classList.add('hidden');
            currentSecretImages = [];
        }

        document.getElementById('form-title').innerHTML='<i data-lucide="edit-3" class="w-6 h-6"></i> ìƒí’ˆ ìˆ˜ì • ì¤‘...'; 
        document.getElementById('form-title').className="font-bold mb-4 flex items-center gap-2 text-green-700"; 
        const btn=document.getElementById('btn-submit-prod'); btn.innerText="ìˆ˜ì •ì™„ë£Œ"; btn.className="flex-1 bg-green-600 text-white py-4 rounded-xl font-bold text-lg hover:bg-green-700 shadow-md transition transform active:scale-95"; 
        document.getElementById('btn-cancel-edit').classList.remove('hidden'); 
        document.getElementById('section-admin').scrollTo({top:0, behavior:'smooth'}); 
        lucide.createIcons(); 
    }
    
    function cancelEdit() { 
        editingProductIndex=-1; 
        document.getElementById('new-prod-name').value=""; 
        document.getElementById('new-prod-price').value=""; 
        document.getElementById('new-prod-cat').value=""; 
        document.getElementById('new-prod-stock').value=""; 
        document.getElementById('new-prod-discount').value=""; 
        document.getElementById('new-prod-expiry').value="30"; 
        clearImage(); 
        
        const secretCheckbox = document.getElementById('is-secret-mode');
        if(secretCheckbox) secretCheckbox.checked = false;
        const secretArea = document.getElementById('secret-img-area');
        if(secretArea) secretArea.classList.add('hidden');
        clearSecretImage();

        document.getElementById('form-title').innerHTML='<i data-lucide="plus-circle" class="w-6 h-6"></i> ìƒí’ˆ ê´€ë¦¬'; 
        document.getElementById('form-title').className="font-bold mb-4 flex items-center gap-2 text-blue-800"; 
        const btn=document.getElementById('btn-submit-prod'); btn.innerText="ë“±ë¡í•˜ê¸°"; btn.className="flex-1 bg-blue-600 text-white py-4 rounded-xl font-bold text-lg hover:bg-blue-700 shadow-md transition transform active:scale-95"; 
        document.getElementById('btn-cancel-edit').classList.add('hidden'); 
        lucide.createIcons(); 
    }
    
    function handleProductSubmit() { 
        const name=document.getElementById('new-prod-name').value; 
        const price=parseInt(document.getElementById('new-prod-price').value); 
        const cat=document.getElementById('new-prod-cat').value; 
        let stock=parseInt(document.getElementById('new-prod-stock').value); 
        
        if(!name || isNaN(price) || !cat || isNaN(stock)) return alert("ìƒí’ˆëª…, ê°€ê²©, ì¹´í…Œê³ ë¦¬, ì¬ê³ ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”."); 
        
        const icon = currentUploadImg || document.getElementById('new-prod-icon').value || "ğŸ"; 
        const discount = parseInt(document.getElementById('new-prod-discount').value)||0; 
        // [NEW] ìœ íš¨ê¸°ê°„ ì €ì¥
        const expiryDays = parseInt(document.getElementById('new-prod-expiry').value)||30;

        const isSecret = document.getElementById('is-secret-mode').checked;
        let finalSecretImages = [];
        
        if(isSecret) {
            if (currentSecretImages.length > 0) {
                finalSecretImages = currentSecretImages;
                stock = currentSecretImages.length; 
            }
            else if (editingProductIndex >= 0 && PRODUCTS[editingProductIndex].secretImages && PRODUCTS[editingProductIndex].secretImages.length > 0) {
                finalSecretImages = PRODUCTS[editingProductIndex].secretImages;
                stock = finalSecretImages.length; 
            }
            else {
                finalSecretImages = [];
            }
        }

        const newProd = {
            id: editingProductIndex >= 0 ? PRODUCTS[editingProductIndex].id : Date.now(), 
            name, 
            basePrice: price, 
            img: icon, 
            category: cat, 
            discount, 
            stock, 
            expiryDays, // [NEW] ì €ì¥
            secretImages: finalSecretImages 
        }; 

        if(editingProductIndex >= 0) { 
            PRODUCTS[editingProductIndex] = newProd; 
            saveData(); 
            renderAdminList(); 
            updateCategoryOptions(); 
            renderCategoryChips(); // [NEW] ì¹© ì—…ë°ì´íŠ¸
            cancelEdit(); 
            setTimeout(() => { alert("ìƒí’ˆì´ ì„±ê³µì ìœ¼ë¡œ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤."); }, 10);
        } else { 
            PRODUCTS.push(newProd); 
            saveData(); 
            renderAdminList(); 
            updateCategoryOptions(); 
            renderCategoryChips(); // [NEW] ì¹© ì—…ë°ì´íŠ¸
            cancelEdit(); 
            setTimeout(() => { alert("ìƒí’ˆì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤."); }, 10);
        } 
    }
</script>
</body>
</html>